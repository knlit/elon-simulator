<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é©¬æ–¯å…‹æ¨¡æ‹Ÿå™¨ï¼šé¦–å¯Œçš„æŒ¥éœç”Ÿæ´»</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ FontAwesome å›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@700&display=swap');

        /* ä¿®å¤ï¼šå¼ºåˆ¶æ˜¾ç¤ºå‚ç›´æ»šåŠ¨æ¡ï¼Œé˜²æ­¢é¡µé¢å·¦å³è·³åŠ¨ */
        html {
            overflow-y: scroll; 
        }

        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Space Grotesk', sans-serif;
            overflow-x: hidden;
        }

        /* å…³é”®ä¿®å¤ï¼šå¼ºåˆ¶æ•°å­—ç­‰å®½ï¼Œé˜²æ­¢è·³åŠ¨ */
        .tabular-nums {
            font-feature-settings: "tnum";
            font-variant-numeric: tabular-nums;
        }

        /* é’ç¥¨é›¨åŠ¨ç”» */
        @keyframes fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        .money-rain {
            position: fixed;
            top: 0;
            color: #22c55e;
            font-size: 24px;
            z-index: 50;
            pointer-events: none;
            animation: fall linear forwards;
        }

        /* éœ“è™¹ç‰¹æ•ˆ */
        .neon-text {
            text-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }
        
        /* ç²˜æ€§é¡¶éƒ¨æ èƒŒæ™¯æ¨¡ç³Š */
        .glass-header {
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ç‰©å“å¡ç‰‡æ‚¬æµ®æ•ˆæœ */
        .item-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            /* ç§»é™¤åŸå…ˆçš„ background-size/positionï¼Œæ”¹ç”¨ img æ ‡ç­¾ */
        }
        .item-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.5);
            border-color: #3b82f6;
            z-index: 10;
        }
        .item-card:hover img {
            transform: scale(1.1); /* å›¾ç‰‡è½»å¾®æ”¾å¤§æ•ˆæœ */
        }
        .item-card:active {
            transform: scale(0.98);
        }

        /* è¿›åº¦æ¡åŠ¨ç”» */
        .progress-fill {
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .income-pulse-pos { color: #22c55e; } /* ç»¿è‰² */
        .income-pulse-neg { color: #ef4444; } /* çº¢è‰² */

        /* è­¦ç¯é—ªçƒåŠ¨ç”» */
        @keyframes police-flash {
            0% { background-color: #450a0a; } /* æ·±çº¢è‰² */
            50% { background-color: #172554; } /* æ·±è“è‰² */
            100% { background-color: #450a0a; }
        }
        .wanted-active {
            animation: police-flash 1s infinite;
        }

        /* åˆ†ç±»æŒ‰é’®æ ·å¼ */
        .category-btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        /* æ–°é—»æ»šåŠ¨æ¡ */
        .news-ticker-container {
            overflow: hidden;
            white-space: nowrap;
            background: #000;
            color: #fca5a5;
            padding: 8px 0;
            font-family: 'Noto Serif SC', serif;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 45;
        }
        .news-ticker {
            display: inline-block;
            animation: ticker 30s linear infinite;
            font-weight: bold;
        }
        @keyframes ticker {
            0% { transform: translateX(100vw); }
            100% { transform: translateX(-100%); }
        }

        /* ä»»åŠ¡å®Œæˆç‰¹æ•ˆ */
        .mission-completed {
            text-decoration: line-through;
            color: #4ade80;
            opacity: 0.6;
        }

        /* ä»ªè¡¨ç›˜é€šç”¨æ ·å¼ */
        .meter-container {
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 4px;
        }
        .meter-fill {
            height: 100%;
            transition: width 0.5s ease;
        }

        /* Grok æŒ‰é’® */
        .grok-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: black;
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            transition: transform 0.2s;
        }
        .grok-btn:hover {
            transform: scale(1.1);
        }
        
        /* AI é—ªçƒ */
        .ai-sparkle {
            animation: sparkle 1.5s infinite;
        }
        @keyframes sparkle {
            0% { text-shadow: 0 0 5px #fff; }
            50% { text-shadow: 0 0 20px #a855f7; color: #d8b4fe; }
            100% { text-shadow: 0 0 5px #fff; }
        }

        /* è­¦å‘Š Toast åŠ¨ç”» */
        .toast-enter {
            transform: translate(-50%, 0);
            opacity: 1;
        }
        .toast-exit {
            transform: translate(-50%, -20px);
            opacity: 0;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col transition-colors duration-500" id="main-body">

    <!-- é¡¶éƒ¨é’±åŒ…æ  (Z-Index 50 ç¡®ä¿æœ€é«˜) -->
    <header class="glass-header sticky top-0 z-50 px-4 py-3 shadow-2xl">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <!-- é’±ä¸è¿›åº¦ -->
            <div class="flex-1 w-full">
                <div class="flex items-center gap-4 mb-1">
                    <!-- å¤´åƒåŒºåŸŸ -->
                    <div class="relative group cursor-pointer">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/34/Elon_Musk_Royal_Society_%28crop2%29.jpg/220px-Elon_Musk_Royal_Society_%28crop2%29.jpg" 
                             class="w-14 h-14 rounded-full border-2 border-green-500 object-cover shadow-[0_0_15px_rgba(34,197,94,0.4)] transition-transform group-hover:scale-105"
                             alt="Elon Musk"
                             onerror="this.onerror=null; this.src='https://placehold.co/100x100/111/4ade80?text=Elon';">
                        <div class="absolute -bottom-1 -right-1 bg-black rounded-full border border-gray-700 p-0.5">
                            <i class="fas fa-check-circle text-blue-400 text-sm"></i>
                        </div>
                    </div>
                    
                    <!-- ä½™é¢åŒºåŸŸ (tabular-nums é˜²æ­¢æ•°å­—è·³åŠ¨) -->
                    <div>
                        <div class="text-[10px] text-gray-400 uppercase tracking-widest font-bold">Total Net Worth</div>
                        <h1 id="balance-display" class="text-2xl md:text-4xl font-bold text-green-400 neon-text font-mono tracking-tighter leading-none whitespace-nowrap tabular-nums">
                            $750,000,000,000
                        </h1>
                    </div>
                </div>

                <div class="w-full bg-gray-800 h-1.5 mt-2 rounded-full overflow-hidden relative group cursor-help">
                    <div id="progress-bar" class="bg-gradient-to-r from-green-500 to-emerald-300 h-full progress-fill w-full"></div>
                    <div class="absolute top-2 left-0 bg-gray-900 text-xs text-white p-2 rounded hidden group-hover:block z-50 border border-gray-600">
                        å¦‚æœèµ„äº§å½’é›¶ï¼Œä½ å°†è·å¾—è‡ªç”±ã€‚
                    </div>
                </div>
                <div class="flex justify-between text-[10px] text-gray-500 mt-1">
                    <span>$0 (ç›®æ ‡)</span>
                    <span id="percentage-text" class="tabular-nums">100% å‰©ä½™</span>
                </div>
            </div>

            <!-- æ ¸å¿ƒæŒ‡æ ‡ä»ªè¡¨ç›˜ -->
            <div class="grid grid-cols-3 gap-3 w-full md:w-1/2">
                <!-- ç´§å¼ åº¦ -->
                <div class="bg-gray-900/80 p-2 rounded border border-gray-700 relative group">
                    <div class="flex justify-between text-[10px] mb-1">
                        <span class="text-gray-400"><i class="fas fa-globe"></i> ç´§å¼ åº¦</span>
                        <span id="tension-val" class="font-bold text-green-400 tabular-nums">0%</span>
                    </div>
                    <div class="meter-container"><div id="tension-bar" class="meter-fill bg-orange-500" style="width: 0%"></div></div>
                    <div class="absolute -bottom-8 left-0 w-full bg-black text-[10px] text-white p-1 rounded hidden group-hover:block z-50 text-center border border-gray-600">
                        100% = èµ„äº§å†»ç»“ (è´¥åŒ—)
                    </div>
                </div>
                
                <!-- æ³•å¾‹é£é™© -->
                <div class="bg-gray-900/80 p-2 rounded border border-gray-700 relative group">
                    <div class="flex justify-between text-[10px] mb-1">
                        <span class="text-gray-400"><i class="fas fa-gavel"></i> é£é™©å€¼</span>
                        <span id="risk-val" class="font-bold text-green-400 tabular-nums">0%</span>
                    </div>
                    <div class="meter-container"><div id="risk-bar" class="meter-fill bg-red-600" style="width: 0%"></div></div>
                    <div class="absolute -bottom-8 left-0 w-full bg-black text-[10px] text-white p-1 rounded hidden group-hover:block z-50 text-center border border-gray-600">
                        100% = ç‰¢åº•åç©¿ (è´¥åŒ—)
                    </div>
                </div>

                <!-- æ”¯æŒç‡ -->
                <div class="bg-gray-900/80 p-2 rounded border border-gray-700 relative group">
                    <div class="flex justify-between text-[10px] mb-1">
                        <span class="text-gray-400"><i class="fas fa-heart"></i> æ”¯æŒç‡</span>
                        <span id="pop-val" class="font-bold text-blue-400 tabular-nums">100%</span>
                    </div>
                    <div class="meter-container"><div id="pop-bar" class="meter-fill bg-blue-500" style="width: 100%"></div></div>
                    <div class="absolute -bottom-12 left-0 w-200 bg-black text-[10px] text-white p-1 rounded hidden group-hover:block z-50 border border-gray-600 -translate-x-1/2">
                        é«˜æ”¯æŒç‡ = è‚¡ä»·é£™å‡(èµ„äº§å¢åŠ )ã€‚<br>ä½ éœ€è¦è®©äººä»¬è®¨åŒä½ ï¼
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- æ‚¬æµ®è­¦å‘Š Toast (é˜²æ­¢å¸ƒå±€è·³åŠ¨) -->
    <div id="toast-warning" class="fixed top-24 left-1/2 transform -translate-x-1/2 z-[60] bg-red-900/90 border border-red-500 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 transition-all duration-300 opacity-0 pointer-events-none translate-y-[-20px]">
        <div class="bg-red-500 rounded-full w-6 h-6 flex items-center justify-center animate-pulse">
            <i class="fas fa-exclamation text-xs"></i>
        </div>
        <span id="toast-text" class="font-bold text-sm"></span>
    </div>

    <!-- æ–°é—»å¿«è®¯ -->
    <div class="news-ticker-container">
        <div id="news-text" class="news-ticker">BREAKING: åŸƒéš†Â·é©¬æ–¯å…‹å®£å¸ƒå…¶ä¸ªäººèµ„äº§è¶…è¿‡éƒ¨åˆ†å›½å®¶GDPï¼Œå¼•å‘è”åˆå›½å…³æ³¨...</div>
    </div>

    <!-- ä¸»è¦å†…å®¹åŒº -->
    <main class="flex-1 max-w-6xl mx-auto w-full p-4 flex flex-col md:flex-row gap-4 relative">
        
        <!-- å·¦ä¾§ï¼šçŠ¶æ€ä¸ä»»åŠ¡ (Sticky, å›ºå®šæœ€å°å®½åº¦) -->
        <div class="w-full md:w-1/4 space-y-4 md:sticky md:top-36 h-fit z-20 min-w-[250px]">
            
            <!-- ç°é‡‘æµé¢æ¿ -->
            <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700 text-center shadow-lg backdrop-blur-md">
                <div class="text-xs text-gray-400 mb-1">æ¯ç§’ç°é‡‘æµ (P/L)</div>
                <!-- ä¿®å¤ï¼štabular-nums é˜²æ­¢æ•°å­—è·³åŠ¨ï¼Œmin-height é˜²æ­¢é«˜åº¦å¡Œé™· -->
                <div id="income-display" class="text-2xl font-bold text-green-500 font-mono whitespace-nowrap overflow-hidden text-ellipsis tabular-nums min-h-[32px]">+$0</div>
                <div id="market-factor" class="text-[10px] text-blue-300 mt-1">å¸‚åœºçƒ­åº¦: 1.0x</div>
            </div>

            <!-- ä»»åŠ¡é¢æ¿ (ä¿®å¤ï¼šç§»é™¤å†…éƒ¨åˆ·æ–°ï¼Œæ”¹ä¸ºæŒ‰éœ€æ›´æ–°) -->
            <div class="bg-gray-900/90 border border-gray-700 rounded-xl p-4 shadow-lg">
                <h3 class="text-green-400 font-bold mb-3 border-b border-gray-700 pb-2 text-sm">
                    <i class="fas fa-tasks"></i> æˆ˜ç•¥ç›®æ ‡
                </h3>
                <div id="mission-list" class="space-y-2 text-xs text-gray-400">
                    <!-- JS ç”Ÿæˆ -->
                </div>
            </div>

            <!-- æ¸¸æˆæç¤º -->
            <div class="bg-blue-900/30 border border-blue-500/30 p-3 rounded-lg text-[10px] text-blue-200">
                <p class="font-bold mb-1"><i class="fas fa-lightbulb"></i> è´¥å®¶æŒ‡å—ï¼š</p>
                <ul class="list-disc pl-4 space-y-1">
                    <li>è±ªè½¦ã€è±ªå®…éœ€è¦å·¨é¢ç»´æŠ¤è´¹ï¼Œè¿™æ˜¯ç ´äº§çš„å¥½å¸®æ‰‹ã€‚</li>
                    <li>å•†ä¸šæŠ•èµ„å¯èƒ½ä¼šèµšé’±(é™·é˜±)ï¼Œä½†èµ›è½¦é˜Ÿå’Œè¶³çƒé˜Ÿé€šå¸¸æ˜¯çƒ§é’±æœºå™¨ã€‚</li>
                    <li>é£é™©å’Œç´§å¼ åº¦ä¸ä¼šè‡ªåŠ¨æ¶ˆå¤±ï¼Œå¿…é¡»èŠ±é’±â€œå¹³äº‹â€ã€‚</li>
                </ul>
            </div>
        </div>

        <!-- å³ä¾§ï¼šå•†åº— -->
        <div class="flex-1 w-full">
            <!-- åˆ†ç±»å¯¼èˆª (æ·»åŠ  Sticky æ”¯æŒ + èƒŒæ™¯é˜²ç©¿é€) -->
            <div class="sticky top-28 z-30 bg-[#0f172a]/95 backdrop-blur-md py-2 -mx-4 px-4 mb-4 border-b border-gray-800 shadow-lg" id="category-sticky-wrapper">
                <div class="flex overflow-x-auto gap-2 pb-1 no-scrollbar" id="category-container">
                    <!-- åˆ†ç±»æŒ‰é’®ç”± JS ç”Ÿæˆ -->
                </div>
            </div>

            <!-- è´­ç‰©ç½‘æ ¼ -->
            <div id="shop-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                <!-- ç‰©å“å°†é€šè¿‡ JS åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

    </main>

    <!-- Grok Button -->
    <button onclick="askGrok()" class="grok-btn group" title="Ask Grok">
        <span class="font-bold font-mono text-white group-hover:hidden">X</span>
        <i class="fas fa-robot text-white hidden group-hover:block ai-sparkle"></i>
    </button>

    <!-- Grok Modal -->
    <div id="grok-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-black border border-white max-w-md w-full p-6 rounded-2xl relative shadow-[0_0_30px_rgba(255,255,255,0.2)]">
            <button onclick="closeGrok()" class="absolute top-2 right-4 text-gray-500 hover:text-white">âœ•</button>
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
                    <span class="font-bold text-black font-mono text-xl">X</span>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-white">Grok æˆ˜ç•¥é¡¾é—®</h3>
                    <p class="text-xs text-gray-400">æ¨¡å¼: é˜´é˜³æ€ªæ°” & æåº¦ç†æ™º</p>
                </div>
            </div>
            <div id="grok-content" class="text-gray-200 font-mono text-sm min-h-[60px] mb-4">
                æ­£åœ¨åˆ†æä½ çš„è´¢åŠ¡è‡ªæ€è®¡åˆ’... <i class="fas fa-circle-notch fa-spin"></i>
            </div>
            <button onclick="callGrokAdvice()" class="w-full bg-white text-black font-bold py-2 rounded hover:bg-gray-200 text-xs">
                <i class="fas fa-magic mr-1"></i> è·å–ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®
            </button>
        </div>
    </div>

    <!-- æ¸¸æˆä»‹ç» (Intro) -->
    <div id="intro-modal" class="fixed inset-0 bg-black/95 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-900 border-2 border-red-600 max-w-lg w-full p-8 rounded-xl shadow-[0_0_50px_rgba(220,38,38,0.3)] text-center relative">
            <h1 class="text-4xl font-black text-white mb-2 uppercase italic tracking-widest text-red-500">ç ´äº§å±æœº</h1>
            <p class="text-gray-400 font-mono text-xs mb-6">DIFFICULTY: HARDCORE STRATEGY</p>
            
            <div class="text-left bg-black/50 p-4 rounded border border-gray-800 mb-6 text-sm space-y-3">
                <p><strong>ç›®æ ‡ï¼š</strong> å°† $7500äº¿ å½’é›¶ã€‚</p>
                <p class="text-yellow-400"><strong>æ–¹å¼ 1ï¼šæŠ¥å¤æ€§æ¶ˆè´¹</strong><br>
                <span class="text-gray-400 text-xs">ä¹°è·‘è½¦ã€ä¹°æµ·å²›ã€ä¹°æé¾™åŒ–çŸ³ï¼å°½æƒ…äº«å—æœ‰é’±äººçš„æ¯ç‡¥ç”Ÿæ´»ã€‚è¿™äº›ä¸œè¥¿ç»´æŠ¤è´¹æé«˜ã€‚</span></p>
                
                <p class="text-red-400"><strong>é™·é˜± 2ï¼šæ³•å¾‹åˆ¶è£</strong><br>
                <span class="text-gray-400 text-xs">é£é™©å€¼æ»¡ 100% ç›´æ¥åç‰¢ã€‚ä½ å¿…é¡»èŠ±é’±é›‡ä½£å¾‹å¸ˆå’Œå…¬å…³æ¥æ´—ç™½ã€‚</span></p>

                <p class="text-blue-400"><strong>é™·é˜± 3ï¼šå¤§è€Œä¸å€’</strong><br>
                <span class="text-gray-400 text-xs">å¦‚æœä½ ç ´äº§å¤ªå¿«ï¼Œæ”¿åºœä¼šå¼ºè¡Œç»™ä½ æ³¨èµ„æ•‘å¸‚ã€‚è¯·ä¿æŒèŠ‚å¥ã€‚</span></p>
            </div>

            <button onclick="startGame()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-4 rounded transition-all transform hover:scale-[1.02] shadow-lg">
                å¼€å§‹æŒ‘æˆ˜
            </button>
        </div>
    </div>

    <!-- ç»“å±€å¼¹çª—æ¨¡æ¿ -->
    <div id="modal-end" class="fixed inset-0 bg-black/95 z-50 flex items-center justify-center hidden p-4">
        <div class="bg-gray-900 border border-gray-600 max-w-md w-full text-center rounded-xl p-8">
            <div id="end-icon" class="text-6xl mb-4"></div>
            <h2 id="end-title" class="text-3xl font-bold mb-2 text-white"></h2>
            <p id="end-msg" class="text-gray-300 mb-6 text-sm"></p>
            <button onclick="location.reload()" class="bg-white text-black font-bold py-3 px-8 rounded-full w-full hover:bg-gray-200">
                é‡æ–°å¼€å§‹
            </button>
        </div>
    </div>

    <script>
        // API Key
        const apiKey = ""; 

        // æ¸¸æˆæ ¸å¿ƒçŠ¶æ€
        let gameStarted = false;
        const INITIAL_MONEY = 750000000000;
        let currentMoney = INITIAL_MONEY;
        let incomeRate = 0; // åŸºç¡€æ”¶å…¥/æ”¯å‡º
        let activeCategory = 'all';
        
        // æ ¸å¿ƒæ•°å€¼
        let legalRisk = 0;      // 0-100: æ»¡åˆ™å…¥ç‹±
        let globalTension = 0;  // 0-100: æ»¡åˆ™å†»ç»“
        let popularity = 100;   // 0-100: è¶Šé«˜èµšé’±è¶Šå¿«ï¼Œè¶Šä½èµ”é’±è¶Šå¿«
        
        // å¸‚åœºå› å­
        let marketMultiplier = 1.0; 
        
        // å†å²è®°å½• (ç”¨äºæ£€æµ‹æš´è·Œè§¦å‘æ•‘å¸‚)
        let moneyHistory = [];

        // ç‰©å“åº“ (Updated images via pollinations.ai)
        const items = [
            // --- è±ªè½¦è¶…è·‘ (Cars) ---
            { 
                id: 101, name: "å¸ƒåŠ è¿ªé™é‡ç‰ˆ", price: 10000000, 
                img: "https://image.pollinations.ai/prompt/Bugatti%20Chiron%20Super%20Sport%20hypercar%20black%20and%20orange%20photorealistic?width=400&height=240&nologo=true",
                desc: "æ²¹è€—æƒŠäººï¼Œä¿é™©æ›´è´µ", income: -50000, category: "cars", popDelta: 2 
            },
            { 
                id: 102, name: "æ³•æ‹‰åˆ© 250 GTO", price: 50000000, 
                img: "https://image.pollinations.ai/prompt/Ferrari%20250%20GTO%20classic%20red%20race%20car%20photorealistic?width=400&height=240&nologo=true",
                desc: "ä»…ä»…æ˜¯æ”¾åœ¨è½¦åº“é‡Œå°±è¦èŠ±é’±ä¿å…»", income: -10000, category: "cars", popDelta: 5 
            },
            { 
                id: 103, name: "çº¯é‡‘ Cybertruck", price: 100000000, 
                img: "https://image.pollinations.ai/prompt/Solid%20gold%20Tesla%20Cybertruck%20shiny%20reflective%20photorealistic?width=400&height=240&nologo=true",
                desc: "åœŸå¾—æ‰æ¸£ï¼Œä½†çœŸçš„å¾ˆè´µ", income: 0, category: "cars", popDelta: -5 
            },
            { 
                id: 104, name: "F1 è½¦é˜Ÿ", price: 200000000, 
                img: "https://image.pollinations.ai/prompt/Formula%201%20race%20car%20speeding%20on%20track%20photorealistic?width=400&height=240&nologo=true",
                desc: "ä¸–ç•Œä¸Šæœ€çƒ§é’±çš„è¿åŠ¨", income: -2000000, category: "cars", popDelta: 10 
            },

            // --- é¡¶çº§è±ªå®… (Luxury Estates) ---
            { 
                id: 201, name: "åŠ å‹’æ¯”ç§äººæµ·å²›", price: 150000000, 
                img: "https://image.pollinations.ai/prompt/Tropical%20private%20island%20with%20luxury%20villa%20aerial%20view?width=400&height=240&nologo=true",
                desc: "è¿™å°±æ˜¯ä½ çš„æµ·ç›—åŸºåœ°", income: -500000, category: "luxury", tensionDelta: 2 
            },
            { 
                id: 202, name: "æ³•å›½å‡¡å°”èµ›å¼åŸå ¡", price: 200000000, 
                img: "https://image.pollinations.ai/prompt/French%20chateau%20castle%20luxury%20garden%20photorealistic?width=400&height=240&nologo=true",
                desc: "ä¿®ç¼®å±‹é¡¶å°±è¦èŠ±å‡ ç™¾ä¸‡", income: -200000, category: "luxury", popDelta: 2 
            },
            { 
                id: 203, name: "æœ«æ—¥åœ°å ¡", price: 500000000, 
                img: "https://image.pollinations.ai/prompt/Underground%20luxury%20doomsday%20bunker%20interior%20sci-fi?width=400&height=240&nologo=true",
                desc: "å³ä½¿æ ¸æˆ˜çˆ†å‘ä¹Ÿèƒ½æ´»å¾—å¾ˆæ»‹æ¶¦", income: -100000, category: "luxury", riskDelta: -5 
            },
            { 
                id: 204, name: "é˜¿å°”å‘æ–¯æ»‘é›ªåœº", price: 1000000000, 
                img: "https://image.pollinations.ai/prompt/Luxury%20ski%20resort%20Swiss%20Alps%20snow%20mountain?width=400&height=240&nologo=true",
                desc: "åªä¸ºä½ ä¸€ä¸ªäººå¼€æ”¾", income: -1000000, category: "luxury", popDelta: -2 
            },

            // --- ç¨€ä¸–çå® (Collection) ---
            { 
                id: 301, name: "éœ¸ç‹é¾™éª¨æ¶", price: 30000000, 
                img: "https://image.pollinations.ai/prompt/T-Rex%20dinosaur%20fossil%20skeleton%20museum%20lighting?width=400&height=240&nologo=true",
                desc: "è¿™ä¸œè¥¿æ”¾åœ¨å®¢å…å¾ˆéœ¸æ°”", income: -10000, category: "collection", popDelta: 5 
            },
            { 
                id: 302, name: "å¸Œæœ›è“é’»", price: 350000000, 
                img: "https://image.pollinations.ai/prompt/Hope%20Diamond%20blue%20gemstone%20close%20up%20macro?width=400&height=240&nologo=true",
                desc: "ä¼ è¯´ä¸­å¸¦æœ‰è¯…å’’çš„é’»çŸ³", income: 0, category: "collection", popDelta: 10 
            },
            { 
                id: 303, name: "è¾¾èŠ¬å¥‡çœŸè¿¹", price: 450000000, 
                img: "https://image.pollinations.ai/prompt/Leonardo%20Da%20Vinci%20painting%20Salvator%20Mundi%20style?width=400&height=240&nologo=true",
                desc: "å®‰ä¿è´¹ç”¨æ˜¯ä¸ªå¤©æ–‡æ•°å­—", income: -50000, category: "collection", popDelta: 15 
            },
            { 
                id: 304, name: "ç¾å›½å®ªæ³•åŸä»¶", price: 50000000, 
                img: "https://image.pollinations.ai/prompt/Old%20parchment%20US%20Constitution%20document%20historic?width=400&height=240&nologo=true",
                desc: "æŠŠå®ƒä¹°ä¸‹æ¥ï¼Œåªæ˜¯ä¸ºäº†å¥½ç©", income: 0, category: "collection", popDelta: 5, tensionDelta: 5 
            },

            // --- è¿è¥ç»´æŠ¤ (å¿…é¡»å“) ---
            { id: 901, name: "é¡¶çº§å¾‹å¸ˆå›¢é˜Ÿ", price: 50000000, img: "https://image.pollinations.ai/prompt/Group%20of%20lawyers%20in%20suits%20courtroom?width=400&height=240&nologo=true", desc: "é™ä½æ³•å¾‹é£é™© (-0.5%/s)", income: -5000000, category: "management", effect: "risk_down" },
            { id: 902, name: "å…¨çƒå…¬å…³å…¬å¸", price: 30000000, img: "https://image.pollinations.ai/prompt/Press%20conference%20microphones%20media?width=400&height=240&nologo=true", desc: "é™ä½å›½é™…ç´§å¼ åº¦ (-0.5%/s)", income: -3000000, category: "management", effect: "tension_down" },
            { id: 903, name: "æ°´å†›æ§è¯„", price: 10000000, img: "https://image.pollinations.ai/prompt/Server%20room%20hacker%20matrix%20code?width=400&height=240&nologo=true", desc: "ç•¥å¾®é™ä½äººæ°” (-0.2%/s)", income: -1000000, category: "management", effect: "pop_down" },

            // --- å•†ä¸š (æœ‰äº›æ˜¯èµšé’±é™·é˜±) ---
            { id: 11, name: "æ”¶è´­ Twitter", price: 44000000000, img: "https://image.pollinations.ai/prompt/Twitter%20HQ%20building%20X%20logo%20night?width=400&height=240&nologo=true", desc: "é™ä½äººæ°”ï¼Œå¢åŠ äºæŸ (å¥½ä¸œè¥¿!)", income: -10000000, category: "business", popDelta: -15, tensionDelta: 5 },
            { id: 401, name: "æ”¶è´­ Disney", price: 180000000000, img: "https://image.pollinations.ai/prompt/Disney%20castle%20magic%20kingdom%20fireworks?width=400&height=240&nologo=true", desc: "é™·é˜±ï¼šè¿™ä¼šè®©ä½ ç”šè‡³æ›´å—æ¬¢è¿", income: 50000000, category: "business", popDelta: 20, tensionDelta: 0 }, 
            { id: 402, name: "ç‚’ä½œåŠ å¯†è´§å¸", price: 5000000000, img: "https://image.pollinations.ai/prompt/Bitcoin%20crashing%20chart%20red%20line?width=400&height=240&nologo=true", desc: "é«˜é£é™©ï¼šå¯èƒ½æš´èµšä¹Ÿå¯èƒ½æš´é›·", income: 0, category: "business", popDelta: -5, riskDelta: 10, effect: "gamble" },

            // --- ç§‘æŠ€ (é€šå¸¸å¢åŠ äººæ°” = åäº‹) ---
            { id: 8, name: "çŒé¹°9å·å‘å°„", price: 67000000, img: "https://image.pollinations.ai/prompt/SpaceX%20Falcon%209%20rocket%20launch%20flames?width=400&height=240&nologo=true", desc: "è™½è´µï¼Œä½†ä¼šå¢åŠ äººæ°”(æ”¶å…¥å¢åŠ )", income: 5000000, category: "tech", popDelta: 5, tensionDelta: 2 },
            { id: 13, name: "ç«æ˜Ÿæ®–æ°‘åœ°", price: 100000000000, img: "https://image.pollinations.ai/prompt/Mars%20colony%20domes%20red%20planet%20surface?width=400&height=240&nologo=true", desc: "å·¨é¢ç»´æŠ¤è´¹ï¼Œä½†æé«˜äººæ°”", income: -50000000, category: "tech", popDelta: 30, tensionDelta: 15 },
            { id: 505, name: "ç§äººæ­¦è£…", price: 500000000, img: "https://image.pollinations.ai/prompt/Futuristic%20soldiers%20mercenaries%20desert?width=400&height=240&nologo=true", desc: "å¢åŠ ç´§å¼ åº¦ï¼Œé™ä½äººæ°”", income: -20000000, category: "tech", popDelta: -10, tensionDelta: 25, riskDelta: 15 },

            // --- æ”¿æ²»ä¸æäº‹ (é™äººæ°”åˆ©å™¨) ---
            { id: 701, name: "æ¿€è¿›æ”¿æ²»çŒ®é‡‘", price: 2000000000, img: "https://image.pollinations.ai/prompt/Politicians%20shaking%20hands%20dark%20room%20money?width=400&height=240&nologo=true", desc: "å¤§å¹…é™ä½äººæ°”ï¼Œé«˜é£é™©", income: 0, category: "politics", popDelta: -20, riskDelta: 20, tensionDelta: 10 },
            { id: 602, name: "ç›´æ’­çƒ§é’±", price: 1000000000, img: "https://image.pollinations.ai/prompt/Bonfire%20of%20US%20dollar%20bills%20burning?width=400&height=240&nologo=true", desc: "æåº¦å±é™©ï¼Œåˆ«ä¹°å¤ªå¤š", income: 0, category: "politics", popDelta: -50, riskDelta: 40, effect: "crime" },
            { id: 603, name: "ç§äººæ¼”å”±ä¼š", price: 10000000, img: "https://image.pollinations.ai/prompt/Pop%20star%20singing%20on%20stage%20concert?width=400&height=240&nologo=true", desc: "è¯·éœ‰éœ‰æ¥å®¶é‡Œå”±é¦–æ­Œ", income: 0, category: "politics", popDelta: 2 },
        ];

        const categories = [
            { id: 'all', name: 'å…¨éƒ¨', icon: 'fa-list' },
            { id: 'management', name: 'è¿è¥ç»´æŠ¤', icon: 'fa-shield-alt' },
            { id: 'cars', name: 'è±ªè½¦æ”¶è—', icon: 'fa-car' },
            { id: 'luxury', name: 'é¡¶çº§è±ªå®…', icon: 'fa-home' },
            { id: 'collection', name: 'ç¨€ä¸–çå®', icon: 'fa-gem' },
            { id: 'business', name: 'å•†ä¸šå¸å›½', icon: 'fa-briefcase' },
            { id: 'tech', name: 'é»‘ç§‘æŠ€', icon: 'fa-rocket' },
            { id: 'politics', name: 'æäº‹', icon: 'fa-bullhorn' },
        ];

        let inventory = {};

        // ä»»åŠ¡ (å¸¦çŠ¶æ€è¿½è¸ªï¼Œé˜²æ­¢é‡å¤åˆ·æ–°)
        const missions = [
            { id: 'hate_me', desc: "å…¨æ°‘å…¬æ•Œï¼šå°†æ”¯æŒç‡é™è‡³ 20% ä»¥ä¸‹", completed: false, check: () => popularity < 20 },
            { id: 'loss_leader', desc: "äºæŸå¤§äº¨ï¼šæ¯ç§’äºæŸè¶…è¿‡ 1 äº¿ç¾å…ƒ", completed: false, check: () => calculateRealIncome() < -100000000 },
            { id: 'safe_landing', desc: "èµ°é’¢ä¸ï¼šé£é™©å’Œç´§å¼ åº¦éƒ½è¶…è¿‡ 80% ä½†æœªå¤±è´¥", completed: false, check: () => legalRisk > 80 && globalTension > 80 },
            { id: 'half_way', desc: "åŠå±±è…°ï¼šèµ„äº§å‰©ä½™ä¸åˆ° 3750 äº¿", completed: false, check: () => currentMoney < INITIAL_MONEY * 0.5 },
        ];

        // --- Core Game Logic ---

        function init() {
            renderCategories();
            renderShop();
            renderMissions(); // åªåœ¨åˆå§‹åŒ–æ—¶æ¸²æŸ“ä¸€æ¬¡
            updateUI();
            
            setInterval(gameLoop, 1000);
        }

        function gameLoop() {
            if (!gameStarted) return;
            if (checkGameOver()) return;

            // 1. è®¡ç®—ç»´æŠ¤è´¹å½±å“
            if (!inventory[901]) legalRisk += 0.5; 
            if (!inventory[902]) globalTension += 0.5; 
            
            processPassiveEffects();

            // 2. æ”¶å…¥è®¡ç®—
            let realIncome = calculateRealIncome();
            currentMoney += realIncome;

            // 3. è®°å½•å†å²
            moneyHistory.push(currentMoney);
            if(moneyHistory.length > 10) moneyHistory.shift();
            checkBailout();

            // 4. éšæœºäº‹ä»¶
            triggerRandomEvents();

            // 5. é™åˆ¶æ•°å€¼èŒƒå›´
            legalRisk = Math.max(0, Math.min(100, legalRisk));
            globalTension = Math.max(0, Math.min(100, globalTension));
            popularity = Math.max(0, Math.min(100, popularity));
            currentMoney = Math.max(0, currentMoney);

            updateUI();
            checkMissions();
        }

        function calculateRealIncome() {
            let baseIncome = 0;
            baseIncome += currentMoney * 0.0001; 

            items.forEach(item => {
                if (inventory[item.id] > 0) {
                    baseIncome += item.income * inventory[item.id];
                }
            });

            let popMultiplier = 1 + ((popularity - 50) / 50); 
            
            if (baseIncome > 0) {
                return baseIncome * popMultiplier;
            } else {
                let crashFactor = 1 + ((50 - popularity) / 50); 
                if (crashFactor < 0.5) crashFactor = 0.5; 
                return baseIncome * crashFactor; 
            }
        }

        function processPassiveEffects() {
            if (inventory[901]) legalRisk -= (0.5 * inventory[901]);
            if (inventory[902]) globalTension -= (0.5 * inventory[902]);
            if (inventory[903]) popularity -= (0.2 * inventory[903]);
        }

        function checkBailout() {
            if (moneyHistory.length < 10) return;
            let start = moneyHistory[0];
            let end = moneyHistory[moneyHistory.length - 1];
            if (start - end > 50000000000) {
                if (Math.random() < 0.3) {
                    let bailoutAmount = 100000000000;
                    currentMoney += bailoutAmount;
                    triggerNews("çªå‘ï¼šæ”¿åºœå®£å¸ƒä½ ä¹Ÿå±äº'å¤§è€Œä¸å€’'ï¼Œå¼ºåˆ¶æ³¨èµ„1000äº¿ç¾å…ƒï¼");
                    showWarning("è§¦å‘é™·é˜±ï¼šæ”¿åºœæ•‘å¸‚ï¼èµ„äº§å›è¡€ï¼");
                    moneyHistory = [];
                }
            }
        }

        function triggerRandomEvents() {
            if (Math.random() > 0.05) return; 

            if (legalRisk > 50) {
                triggerNews("å¸æ³•éƒ¨å®£å¸ƒå¯¹ä½ çš„å•†ä¸šå¸å›½å±•å¼€åå„æ–­è°ƒæŸ¥ã€‚");
                legalRisk += 5;
            }
            if (popularity > 80) {
                triggerNews("ç²‰ä¸å›¢ç–¯ç‹‚ä¹°å…¥ä½ çš„è‚¡ç¥¨ï¼Œè‚¡ä»·åˆ›å†å²æ–°é«˜ï¼");
                currentMoney += 5000000000; 
                showWarning("äººæ°”å¤ªé«˜å¯¼è‡´èµ„äº§å¢å€¼ï¼");
            }
        }

        function checkGameOver() {
            if (legalRisk >= 100) {
                endGame("ğŸ‘®â€â™‚ï¸", "ç‰¢åº•åç©¿", "ä½ çš„æ¿€è¿›ç­–ç•¥è§¦çŠ¯äº†åº•çº¿ã€‚ä½ å°†åœ¨è”é‚¦ç›‘ç‹±åº¦è¿‡ä½™ç”Ÿï¼Œèµ„äº§è¢«æ²¡æ”¶ã€‚");
                return true;
            }
            if (globalTension >= 100) {
                endGame("ğŸ§Š", "èµ„äº§å†»ç»“", "è”åˆå›½è®¤å®šä½ ä¸ºå…¨çƒå®‰å…¨å¨èƒã€‚ä½ çš„æ‰€æœ‰è´¦æˆ·å·²è¢«å†»ç»“ã€‚ä½ è¾“äº†ï¼Œå› ä¸ºé’±è¿˜åœ¨ã€‚");
                return true;
            }
            if (currentMoney <= 0) {
                endGame("ğŸ†", "å®Œç¾ç ´äº§", "ä¸å¯æ€è®®ï¼ä½ åœ¨æ²¡æœ‰å…¥ç‹±çš„å‰æä¸‹èŠ±å…‰äº†æ‰€æœ‰é’±ã€‚ä½ è·å¾—äº†çœŸæ­£çš„è‡ªç”±ã€‚");
                return true;
            }
            return false;
        }

        function endGame(icon, title, msg) {
            gameStarted = false;
            document.getElementById('modal-end').classList.remove('hidden');
            document.getElementById('end-icon').innerText = icon;
            document.getElementById('end-title').innerText = title;
            document.getElementById('end-msg').innerText = msg;
        }

        // --- UI & Interaction ---

        function updateUI() {
            // Money (tabular-nums applied via CSS)
            document.getElementById('balance-display').innerText = '$' + Math.floor(currentMoney).toLocaleString();
            let percent = (currentMoney / INITIAL_MONEY) * 100;
            document.getElementById('progress-bar').style.width = Math.max(0, Math.min(percent, 100)) + '%';
            document.getElementById('percentage-text').innerText = percent.toFixed(2) + '% å‰©ä½™';

            // Meters
            updateMeter('tension', globalTension, 80);
            updateMeter('risk', legalRisk, 80);
            
            // Pop meter
            const popBar = document.getElementById('pop-bar');
            const popVal = document.getElementById('pop-val');
            popBar.style.width = popularity + '%';
            popVal.innerText = popularity.toFixed(1) + '%';

            // Income
            let realInc = calculateRealIncome();
            const incEl = document.getElementById('income-display');
            if (realInc >= 0) {
                incEl.innerText = '+' + Math.floor(realInc).toLocaleString() + '/s';
                incEl.className = "text-2xl font-bold text-red-500 font-mono whitespace-nowrap overflow-hidden text-ellipsis tabular-nums min-h-[32px] income-pulse-neg"; 
                document.getElementById('market-factor').innerText = "èµ„äº§æ­£åœ¨å¢å€¼ (é«˜äººæ°”/åˆ©æ¯)";
            } else {
                incEl.innerText = Math.floor(realInc).toLocaleString() + '/s';
                incEl.className = "text-2xl font-bold text-green-500 font-mono whitespace-nowrap overflow-hidden text-ellipsis tabular-nums min-h-[32px] income-pulse-pos"; 
                document.getElementById('market-factor').innerText = "èµ„äº§æ­£åœ¨ç¼©æ°´ (å®Œç¾)";
            }

            // Shop Buttons State
            const grid = document.getElementById('shop-grid');
            if (grid && grid.children.length > 0) {
                 const currentItems = activeCategory === 'all' ? items : items.filter(i => i.category === activeCategory);
                currentItems.forEach(i => {
                    const btn = document.getElementById(`btn-buy-${i.id}`);
                    if(btn) btn.disabled = currentMoney < i.price;
                });
            }
        }

        function updateMeter(id, val, dangerThresh) {
            const bar = document.getElementById(`${id}-bar`);
            const txt = document.getElementById(`${id}-val`);
            bar.style.width = val + '%';
            txt.innerText = val.toFixed(1) + '%';
            if(val > dangerThresh) {
                txt.classList.add('animate-pulse', 'text-red-500');
            } else {
                txt.classList.remove('animate-pulse', 'text-red-500');
            }
        }

        // Actions: FIXED event handling
        window.buyItem = function(id, e) {
            const item = items.find(i => i.id === id);
            if (currentMoney >= item.price) {
                currentMoney -= item.price;
                inventory[id] = (inventory[id] || 0) + 1;
                
                if (item.popDelta) popularity += item.popDelta;
                if (item.riskDelta) legalRisk += item.riskDelta;
                if (item.tensionDelta) globalTension += item.tensionDelta;

                if (Math.random() > 0.6) generateNews(item.name);
                
                spawnMoneyEffect(e);
                updateUI();
                updateItemUI(id); 
                checkMissions();
            }
        };

        window.sellItem = function(id) {
            const item = items.find(i => i.id === id);
            if (inventory[id] > 0) {
                // Selling returns 50% cash but doesn't revert risk/tension (Punishment)
                currentMoney += item.price * 0.5;
                inventory[id]--;
                updateUI();
                updateItemUI(id);
            }
        };

        // æ–°å¢ï¼šä¸“é—¨æ›´æ–°å•ä¸ªç‰©å“æ•°é‡çš„å‡½æ•°
        function updateItemUI(id) {
            const count = inventory[id] || 0;
            const countEl = document.getElementById(`count-${id}`);
            if(countEl) {
                countEl.innerText = count;
                // Add pop effect
                countEl.classList.remove('scale-150', 'text-green-400');
                void countEl.offsetWidth; // trigger reflow
                countEl.classList.add('scale-150', 'text-green-400');
                setTimeout(() => countEl.classList.remove('scale-150', 'text-green-400'), 200);
            }
        }

        function renderCategories() {
            const container = document.getElementById('category-container');
            container.innerHTML = categories.map(cat => `
                <button onclick="setCategory('${cat.id}')" 
                    class="category-btn whitespace-nowrap px-4 py-2 rounded-full border border-gray-600 text-gray-300 hover:bg-gray-700 transition-colors text-sm flex items-center gap-2 ${activeCategory === cat.id ? 'active' : ''}">
                    <i class="fas ${cat.icon}"></i> ${cat.name}
                </button>
            `).join('');
        }
        
        window.setCategory = function(id) { activeCategory = id; renderCategories(); renderShop(); }

        function renderShop() {
            const grid = document.getElementById('shop-grid');
            const filtered = activeCategory === 'all' ? items : items.filter(i => i.category === activeCategory);
            
            grid.innerHTML = filtered.map(item => {
                let statsHtml = "";
                if(item.income !== 0) statsHtml += `<div class="text-[10px] ${item.income > 0 ? 'text-red-400' : 'text-green-400'}">${item.income > 0 ? '+' : ''}${item.income/1000000}M/s ç°é‡‘æµ</div>`;
                if(item.popDelta) statsHtml += `<div class="text-[10px] text-blue-300">äººæ°” ${item.popDelta > 0 ? '+' : ''}${item.popDelta}</div>`;
                if(item.riskDelta) statsHtml += `<div class="text-[10px] text-red-500">é£é™© +${item.riskDelta}</div>`;
                
                // Use image if available, background-image for card
                const bgStyle = item.img ? `background-image: url('${item.img}');` : '';
                const overlayClass = item.img ? 'bg-black/60 backdrop-blur-[2px]' : ''; // darker overlay for text readability

                return `
                <div class="item-card bg-gray-800 border border-gray-700 rounded-xl p-3 flex flex-col justify-between group relative overflow-hidden h-40">
                    <!-- Image Layer -->
                    <img src="${item.img}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" onerror="this.style.display='none'" />
                    
                    <!-- Gradient Overlay -->
                    <div class="absolute inset-0 bg-gradient-to-t from-black/95 via-black/60 to-black/30"></div>
                    
                    ${item.category === 'management' ? '<div class="absolute top-0 right-0 bg-blue-600 text-white text-[10px] px-2 py-1 rounded-bl z-10">å¿…ä¹°</div>' : ''}
                    
                    <div class="relative z-10">
                        <div class="flex items-center gap-3 mb-1">
                            <div>
                                <div class="font-bold text-white leading-tight text-lg shadow-black drop-shadow-md">${item.name}</div>
                                <div class="text-[10px] text-gray-300 shadow-black drop-shadow-md">${item.desc}</div>
                            </div>
                        </div>
                        <div class="space-y-0.5 mb-1">
                            ${statsHtml}
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mt-auto relative z-10">
                        <div class="text-green-400 font-mono font-bold text-lg shadow-black drop-shadow-md">$${(item.price/1000000).toLocaleString()}M</div>
                        <div class="flex items-center gap-1">
                             <div class="text-white text-xs mr-2 flex items-center font-bold shadow-black drop-shadow-md">
                                æŒ: <span id="count-${item.id}" class="ml-1 text-green-400 font-bold transition-all duration-200 inline-block tabular-nums">${inventory[item.id]||0}</span>
                             </div>
                             <button onclick="buyItem(${item.id}, event)" class="bg-green-600 hover:bg-green-500 text-white px-3 py-1 rounded text-xs font-bold active:scale-95 transition-transform shadow-lg" id="btn-buy-${item.id}">è´­ä¹°</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // å…³é”®ä¿®å¤ï¼šåªæ¸²æŸ“ä¸€æ¬¡ DOM ç»“æ„ï¼Œåç»­åªæ›´æ–°çŠ¶æ€
        function renderMissions() {
            const list = document.getElementById('mission-list');
            list.innerHTML = missions.map(m => `
                <div id="mission-${m.id}" class="text-gray-400 transition-colors duration-300">
                    <i id="icon-${m.id}" class="fas fa-circle text-[8px] mr-1"></i> ${m.desc}
                </div>
            `).join('');
        }

        function checkMissions() {
            missions.forEach(m => {
                if(!m.completed && m.check()) { 
                    m.completed = true; 
                    triggerNews("è¾¾æˆæˆå°±: " + m.desc);
                    
                    // ä»…æ›´æ–° CSS ç±»ï¼Œä¸é‡ç»˜ DOM
                    const el = document.getElementById(`mission-${m.id}`);
                    const icon = document.getElementById(`icon-${m.id}`);
                    if (el && icon) {
                        el.className = "text-green-400 line-through transition-colors duration-300";
                        icon.className = "fas fa-check text-[8px] mr-1";
                    }
                }
            });
        }

        // Gemini & News
        async function generateNews(item) {
            const msgs = [
                `å¸‚åœºéœ‡åŠ¨ï¼šé©¬æ–¯å…‹è´­ä¹° ${item} å¼•å‘çƒ­è®®ï¼`,
                `åˆ†æå¸ˆï¼š${item} å¯èƒ½ä¼šæˆä¸ºé©¬æ–¯å…‹å¸å›½çš„è½¬æŠ˜ç‚¹ã€‚`,
                `çªå‘ï¼š${item} äº¤æ˜“ç»†èŠ‚æ›å…‰ï¼ŒSECè¡¨ç¤ºå…³æ³¨ã€‚`
            ];
            triggerNews(msgs[Math.floor(Math.random()*msgs.length)]);
        }
        
        function triggerNews(text) {
            const t = document.getElementById('news-text');
            t.style.animation = 'none';
            t.offsetHeight; 
            t.innerText = text + "   ///   " + text; 
            t.style.animation = 'ticker 20s linear infinite';
        }

        // ä¿®å¤ï¼šæ›´æ–° Toast æ˜¾ç¤ºé€»è¾‘ï¼Œä½¿ç”¨ transform è€Œé display
        function showWarning(text) {
            const toast = document.getElementById('toast-warning');
            const txt = document.getElementById('toast-text');
            txt.innerText = text;
            
            toast.classList.remove('opacity-0', 'translate-y-[-20px]', 'pointer-events-none');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-[-20px]', 'pointer-events-none');
            }, 3000);
        }

        function spawnMoneyEffect(e) {
            const el = document.createElement('div');
            el.innerText = 'ğŸ’¸';
            el.className = 'money-rain';
            const x = e ? e.clientX : window.innerWidth / 2;
            el.style.left = x + 'px';
            el.style.animationDuration = (Math.random() * 1 + 0.5) + 's';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 2000);
        }

        // AI Advice
        window.askGrok = function() { document.getElementById('grok-modal').classList.remove('hidden'); }
        window.closeGrok = function() { document.getElementById('grok-modal').classList.add('hidden'); }
        window.callGrokAdvice = async function() {
            const el = document.getElementById('grok-content');
            el.innerHTML = "Grok æ­£åœ¨è®¡ç®—æœ€æ„šè ¢çš„æ¶ˆè´¹æ–¹å¼...";
            if (apiKey) {
                 try {
                    const prompt = `Role: Grok AI. Context: Elon Musk Simulator. Stats: Risk ${legalRisk.toFixed(0)}%, Pop ${popularity.toFixed(0)}%, Money $${(currentMoney/1000000000).toFixed(1)}B. Goal: Lose money without jail. Output: 1 sentence Chinese advice.`;
                    const res = await callGemini(prompt);
                    el.innerHTML = res;
                 } catch(e) { el.innerHTML = "Grok ç¦»çº¿ä¸­ï¼šå»ºè®®ä½ ç›´æ¥ä¹°ä¸‹å¯å£å¯ä¹ç„¶åæŠŠé…æ–¹æ”¹å›å»ã€‚"; }
            } else {
                setTimeout(() => {
                    if (popularity > 80) el.innerHTML = "ä½ çš„æ”¯æŒç‡å¤ªé«˜äº†ï¼å¿«å»å‘ç‚¹å¾—ç½ªäººçš„æ¨æ–‡ï¼Œå¦åˆ™è‚¡ç¥¨æ°¸è¿œè·Œä¸ä¸‹æ¥ï¼";
                    else if (legalRisk > 80) el.innerHTML = "è­¦æŠ¥ï¼å¾‹å¸ˆå›¢é˜Ÿåœ¨åº¦å‡å—ï¼Ÿå¿«é›‡æ›´å¤šå¾‹å¸ˆï¼Œå¦åˆ™ä½ è¦åœ¨ç‰¢é‡Œè¿‡å¹´äº†ï¼";
                    else el.innerHTML = "æ—¢ç„¶ä½ è¿™ä¹ˆæœ‰é’±ï¼Œä¸ºä»€ä¹ˆä¸è€ƒè™‘ä¹°ä¸‹æœˆçƒå‘¢ï¼Ÿé‚£è‚¯å®šå¾ˆäºé’±ã€‚";
                }, 1000);
            }
        }
        
        async function callGemini(prompt) {
             const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
             const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
             const data = await response.json();
             return data.candidates?.[0]?.content?.parts?.[0]?.text || "AI Error";
        }

        window.startGame = function() {
            document.getElementById('intro-modal').classList.add('hidden');
            gameStarted = true;
            triggerNews("æ¸¸æˆå¼€å§‹ã€‚è®°ä½ï¼šå¦‚æœä½ ç ´äº§å¤ªå¿«ï¼Œæ”¿åºœä¼šæ•‘ä½ ã€‚æ…¢æ…¢æ¥ã€‚");
        };

        window.onload = init;

    </script>
</body>
</html>